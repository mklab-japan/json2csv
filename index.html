<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ネスト対応 JSON to CSV</title>
</head>
<body>
  <h1>ネスト対応 JSON to CSV 変換</h1>
  <input type="file" id="jsonFile" accept=".json" />
  <button onclick="convert()">変換してダウンロード</button>

  <script>
    function convert() {
      const fileInput = document.getElementById('jsonFile');
      if (!fileInput.files.length) {
        alert('JSONファイルを選択してください');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const json = JSON.parse(event.target.result);
          const items = Array.isArray(json) ? json : [json];
          const flatItems = items.map(flattenObject);

          const headers = [...new Set(flatItems.flatMap(obj => Object.keys(obj)))];
          const rows = flatItems.map(obj =>
            headers.map(header => JSON.stringify(obj[header] ?? "")).join(",")
          );
          const csv = [headers.join(","), ...rows].join("\n");

          downloadCsv(csv);
        } catch (error) {
          alert('JSONの読み取りに失敗しました：' + error.message);
        }
      };
      reader.readAsText(fileInput.files[0]);
    }

    function flattenObject(obj, parentKey = '', result = {}) {
      for (const [key, value] of Object.entries(obj)) {
        const newKey = parentKey ? \`\${parentKey}.\${key}\` : key;
        if (Array.isArray(value)) {
          value.forEach((item, index) => {
            if (typeof item === 'object' && item !== null) {
              flattenObject(item, \`\${newKey}.\${index}\`, result);
            } else {
              result[\`\${newKey}.\${index}\`] = item;
            }
          });
        } else if (typeof value === 'object' && value !== null) {
          flattenObject(value, newKey, result);
        } else {
          result[newKey] = value;
        }
      }
      return result;
    }

    function downloadCsv(csv) {
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "converted.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
